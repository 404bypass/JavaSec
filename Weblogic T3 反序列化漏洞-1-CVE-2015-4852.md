# Weblogic T3 反序列化漏洞-CVE-2015-4852

## 漏洞原理

该漏洞点在weblogic.rjvm.InboundMsgAbbrev.ServerChannelInputStream#resolveClass方法未对要进行反序列化的类进行限制，从而反序列化构造危险类对象执行代码。

## 漏洞复现

## 漏洞分析

调用栈

```java
resolveClass:108, InboundMsgAbbrev$ServerChannelInputStream (weblogic.rjvm)
readNonProxyDesc:1610, ObjectInputStream (java.io)
readClassDesc:1515, ObjectInputStream (java.io)
readOrdinaryObject:1769, ObjectInputStream (java.io)
readObject0:1348, ObjectInputStream (java.io)
readObject:370, ObjectInputStream (java.io)
readObject:66, InboundMsgAbbrev (weblogic.rjvm)
read:38, InboundMsgAbbrev (weblogic.rjvm)
readMsgAbbrevs:283, MsgAbbrevJVMConnection (weblogic.rjvm)
init:213, MsgAbbrevInputStream (weblogic.rjvm)
dispatch:498, MsgAbbrevJVMConnection (weblogic.rjvm)
dispatch:330, MuxableSocketT3 (weblogic.rjvm.t3)
dispatch:387, BaseAbstractMuxableSocket (weblogic.socket)
readReadySocketOnce:967, SocketMuxer (weblogic.socket)
readReadySocket:899, SocketMuxer (weblogic.socket)
processSockets:130, PosixSocketMuxer (weblogic.socket)
run:29, SocketReaderRequest (weblogic.socket)
execute:42, SocketReaderRequest (weblogic.socket)
execute:145, ExecuteThread (weblogic.kernel)
run:117, ExecuteThread (weblogic.kernel)
```

## 漏洞修复

weblogic处理T3序列化数据使用的是java原生readObject，重写了resolveClass方法，其未对反序列化的类进行过滤。漏洞补丁定义了一些黑名单类，在resolveClass方法中判断需要反序列化的类是否在黑名单内，从而禁止恶意类反序列化。

黑名单类：

1. org.apache.commons.collections.functors
2. com.sun.org.apache.xalan.internal.xsltc.trax
3. javassist
4. org.codehaus.groovy.runtime.ConvertedClosure
5. org.codehaus.groovy.runtime.ConversionHandler
6. org.codehaus.groovy.runtime.MethodClosure

黑名单应用于发生对象反序列化的三个位置：

1. weblogic.rjvm.InboundMsgAbbrev.class::ServerChannelInputStream
2. weblogic.rjvm.MsgAbbrevInputStream.class
3. weblogic.iiop.Utils.class

## 参考

https://xz.aliyun.com/t/8443

https://github.com/zhzhdoai/Weblogic_Vuln

https://zh-cn.tenable.com/security/research/tra-2016-09?tns_redirect=true

https://xz.aliyun.com/t/10173
